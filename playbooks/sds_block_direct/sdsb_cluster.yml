---
####################################################################
# Example : SDSB Cluster Playbook
####################################################################
- name: SDSB Cluster Module
  hosts: localhost
  gather_facts: false

  vars_files:
    - ../ansible_vault_vars/ansible_vault_storage_var.yml

  vars:
    # Common connection info for all tasks
    connection_info:
      address: "{{ storage_address }}"
      username: "{{ vault_storage_username }}"
      password: "{{ vault_storage_secret }}"

  tasks:
    #########################################################################
    # Task Name : Add storage node to the cluster with the configuration file
    # Note: This task is supported for Bare Metal and Google Cloud.
    #       This task is not supported for AWS and Microsoft Azure.
    #########################################################################
    - name: Add storage node to the cluster with the configuration file
      hitachivantara.vspone_block.sds_block.hv_sds_block_cluster:
        connection_info: "{{ connection_info }}"
        state: "add_storage_node"
        spec:
          configuration_file: "/tmp/download2/SystemConfigurationFile.csv"
          setup_user_password: "Hitachi1"
      register: result

    - name: Debug the result variable
      ansible.builtin.debug:
        var: result

    #########################################################################
    # Task Name : Add storage node to the cluster using ansible variables
    # Note: This task is supported for Bare Metal and Google Cloud.
    #       This task is not supported for AWS and Microsoft Azure.
    #########################################################################
    - name: Add storage node to the cluster using ansible variables
      hitachivantara.vspone_block.sds_block.hv_sds_block_cluster:
        connection_info: "{{ connection_info }}"
        state: "add_storage_node"
        spec:
          setup_user_password: "vssb-789"
          storage_nodes:
            - host_name: "SDSB-NODE6"
              fault_domain_name: "SC01-PD01-FD01"
              is_cluster_master_role: false
              control_network:
                control_network_ip: "10.76.34.106"
              internode_network:
                internode_network_ip: "192.168.210.106"
              control_internode_network:
                control_internode_network_route_destinations:
                  - "default"
                control_internode_network_route_gateways:
                  - "10.76.34.1"
                control_internode_network_route_interfaces:
                  - "control"
              compute_networks:
                - compute_network_ip: "10.76.27.106"
                  compute_network_gateway: "10.76.27.1"
      register: result

    - name: Debug the result variable
      ansible.builtin.debug:
        var: result

    #######################################################################
    # Task Name : Remove storage node from the cluster by storage node ID
    # Note: This task is supported for Bare Metal and Google Cloud.
    #       This task is not supported for AWS and Microsoft Azure.
    #       For Google Cloud, it works only for storage nodes, that were
    #       unsuccessful in adding storage nodes operation.
    #######################################################################
    - name: Remove storage node from the cluster by storage node ID
      hitachivantara.vspone_block.sds_block.hv_sds_block_cluster:
        connection_info: "{{ connection_info }}"
        state: "remove_storage_node"
        spec:
          node_id: "8deb71e9-cdba-4002-94bc-c2f6f7a1bee7"
      register: result

    - name: Debug the result variable
      ansible.builtin.debug:
        var: result

    #######################################################################
    # Task Name : Remove storage node from the cluster by storage node name
    # Note: This task is supported for Bare Metal and Google Cloud.
    #       This task is not supported for AWS and Microsoft Azure.
    #       For Google Cloud, it works only for storage nodes, that were
    #       unsuccessful in adding storage nodes operation.
    #######################################################################
    - name: Remove storage node from the cluster by storage node name
      hitachivantara.vspone_block.sds_block.hv_sds_block_cluster:
        connection_info: "{{ connection_info }}"
        state: "remove_storage_node"
        spec:
          node_name: "vssbesxi1"
      register: result

    - name: Debug the result variable
      ansible.builtin.debug:
        var: result

    ####################################################################
    # Task Name : Download cluster configuration file
    # Note: This task is supported for Bare Metal and Google Cloud.
    #       This task is not supported for AWS and Microsoft Azure.
    ####################################################################
    - name: Download cluster configuration file
      hitachivantara.vspone_block.sds_block.hv_sds_block_cluster:
        connection_info: "{{ connection_info }}"
        state: "download_config_file"
        spec:
          config_file_location: "/tmp/download2"
      register: result

    - name: Debug the result variable
      ansible.builtin.debug:
        var: result

    ########################################################################
    # Task Name : Create the cluster configuration file and then download it
    # Note: This task is supported for Bare Metal and Google Cloud.
    #       This task is not supported for AWS and Microsoft Azure.
    ########################################################################
    - name: Create the cluster configuration file and then download it
      hitachivantara.vspone_block.sds_block.hv_sds_block_cluster:
        connection_info: "{{ connection_info }}"
        state: "download_config_file"
        spec:
          config_file_location: "/tmp/download2"
          refresh: true
      register: result

    - name: Debug the result variable
      ansible.builtin.debug:
        var: result
